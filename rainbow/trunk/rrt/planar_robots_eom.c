#include "mex.h"
#include <ctype.h> 
#include <math.h>  
#include <stdarg.h>
#include <stdio.h> 
#include <stdlib.h>
#include <string.h>

/* Degrees to radians conversion */
#define Pi			3.14159265358979323846264338327950288419716939937510582
#define DEGtoRAD	0.01745329251994329576923690768488612713442871888541725
#define	RADtoDEG	57.2957795130823208767981548141051703324054724665643215
#define G			9.81
#define _NAN        9.99E+305

void     define(const double *Torque, const double *Q, const double *U, const double *Theta);
void	 evaluate(void);
void     output(double Up[], double config[], double echeck[]);

double   BETA,C1,C2,C3,C4,C5,C6,L1,L2,LN,M1,M2,M3,R,T1,T2,T3,T4,T5,T6,V1,V2,V3,V4,V5,V6,L3,Q1,Q2,Q3,Q4,Q5,Q6,U1,U2,U3,U4,WCHECK1,L3p;
double   TF1,TF2,TF3,TF4,TF5,TF6,U5,U6,U1p,U2p,U3p,U4p,U5p,U6p,ECHECK;
double   z[237],CONFIG[1],PX[6],PY[6];


/* ................................ MAIN ............................. */
void mexFunction(int nlhs, mxArray *plhs[], int nrhs, const mxArray *prhs[])
{
	int nrows = 6; int ncols = 1;
	int ii, jj, n; int m = 0;
	double *Torque, *Q, *U, *Theta;
	double *Up, *config=NULL, *echeck=NULL, *px, *py;

    /* Assign pointers to each input and output. */
	Torque = mxGetPr(prhs[0]);
	Q  = mxGetPr(prhs[1]);
	U = mxGetPr(prhs[2]);
	Theta = mxGetPr(prhs[3]);
    if (mxGetM(prhs[0]) != 6)
    {
        mexErrMsgTxt("Not enough torques specified.");
    }

    if (mxGetM(prhs[1]) != 6)
    {
        mexErrMsgTxt("Not enough Qs specified.");
    }

    if (mxGetM(prhs[2]) != 6)
    {
        mexErrMsgTxt("Not enough Qps specified.");
    }

    if (mxGetM(prhs[3]) != 20)
    {
        mexErrMsgTxt("Not enough arguments specified for theta vector.");
    }
	
	/* Evaluate output quantities */
	define(Torque,Q,U,Theta);
	evaluate();
	
   	/* Create matrix for the return argument. */
	plhs[0] = mxCreateDoubleMatrix(nrows,ncols, mxREAL);
	Up = mxGetPr(plhs[0]);

    if (nlhs > 1) 
    {
        plhs[1] = mxCreateDoubleMatrix(1,1, mxREAL);
        config = mxGetPr(plhs[1]);
        if (nlhs > 2) 
        {
            plhs[2] = mxCreateDoubleMatrix(1,1, mxREAL);
            echeck = mxGetPr(plhs[2]);
        }
        
        if (nlhs > 3)
        {
            plhs[3] = mxCreateDoubleMatrix(6,1, mxREAL);
            px = mxGetPr(plhs[3]);
            for (n=0; n < 6; ++n) px[n] = PX[n];
        }
        
        if (nlhs > 4)
        {
            plhs[4] = mxCreateDoubleMatrix(6,1, mxREAL);
            py = mxGetPr(plhs[4]);
            for (n=0; n < 6; ++n) py[n] = PY[n];
        }
    }
    output(Up,config,echeck);
}

/* ............................. DEFINITIONS ........................... */

void define(const double *Torque, const double *Q, const double *U, const double *Theta)
{
	// define joint torques from input
	T1 = Torque[0];
	T2 = Torque[1];
	T3 = Torque[2];
	T4 = Torque[3];
	T5 = Torque[4];
	T6 = Torque[5];

	// define joint angles from input
	Q1 = Q[0];
	Q2 = Q[1];
	Q3 = Q[2];
	Q4 = Q[3];
	Q5 = Q[4];
	Q6 = Q[5];
	
	// define joint velocities from input
	U1 = U[0];
	U2 = U[1];
	U3 = U[2];
	U4 = U[3];
	U5 = U[4];
	U6 = U[5];
	
	// define robot parameters from theta
    LN = Theta[0];
    L1 = Theta[1];
    L2 = Theta[2];
    R = Theta[3];
    M1 = Theta[4];
    M2 = Theta[5];
    M3 = Theta[6];
    C1 = Theta[7];
    C2 = Theta[8];
    C3 = Theta[9];
    C4 = Theta[10];
    C5 = Theta[11];
    C6 = Theta[12];
    V1 = Theta[13];
    V2 = Theta[14];
    V3 = Theta[15];
    V4 = Theta[16];
    V5 = Theta[17];
    V6 = Theta[18];
    BETA = Theta[19];
}

/* ................................ OUTPUT ............................. */

void output(double Up[], double config[], double echeck[])
{
	Up[0]=U1p;
	Up[1]=U2p;
	Up[2]=U3p;
	Up[3]=U4p;
	Up[4]=U5p;
	Up[5]=U6p;
    
    if (config != NULL) 
    {        
        config[0] = CONFIG[0];
        //config[1] = CONFIG[1];
    }
    
    if (echeck != NULL) {
        echeck[0] = ECHECK;
    }
}

/* ................................ EQNS .............................. */

void evaluate(void)
{
/* Evaluate constants */
  z[4] = cos(Q1);
  z[5] = sin(Q1);
  z[16] = pow(z[4],2) + pow(z[5],2);
  TF1 = V1*U1 + C1*tanh(BETA*U1);
  z[127] = T1 - TF1;
  z[136] = z[16]*z[127];
  z[6] = cos(Q2);
  z[70] = LN*z[16];
  z[76] = z[5]*z[70];
  z[7] = sin(Q2);
  z[75] = z[4]*z[70];
  z[71] = L1*z[16];
  z[77] = z[75] - z[71];
  z[81] = -z[6]*z[76] - z[7]*z[77];
  z[64] = z[16]*U1;
  z[105] = z[70]*U1*z[64];
  z[110] = z[4]*z[105];
  z[17] = pow(z[6],2) + pow(z[7],2);
  z[72] = L1*z[17];
  z[65] = z[17]*U2;
  z[111] = z[110] - (z[71]*U1+z[72]*U2)*(z[64]+z[65]);
  z[109] = z[5]*z[105];
  z[113] = z[6]*z[111] - z[7]*z[109];
  z[73] = L2*z[16];
  z[74] = L2*z[17];
  z[8] = cos(Q3);
  z[9] = sin(Q3);
  z[18] = pow(z[8],2) + pow(z[9],2);
  z[82] = L2*z[18];
  z[66] = z[18]*U3;
  z[114] = z[113] - (z[73]*U1+z[74]*U2+z[82]*U3)*(z[64]+z[65]+z[66]);
  z[78] = z[6]*z[77] - z[7]*z[76];
  z[83] = z[78] - z[73];
  z[112] = z[6]*z[109] + z[7]*z[111];
  z[106] = z[71]*U1*z[64];
  z[10] = cos(Q4);
  z[11] = sin(Q4);
  z[19] = pow(z[10],2) + pow(z[11],2);
  z[85] = LN*z[19];
  z[67] = z[19]*U4;
  z[115] = z[85]*U4*z[67];
  z[25] = -z[4]*z[10] - z[5]*z[11];
  z[86] = L1*z[19];
  z[12] = cos(Q5);
  z[13] = sin(Q5);
  z[20] = pow(z[12],2) + pow(z[13],2);
  z[91] = L1*z[20];
  z[14] = cos(Q6);
  z[15] = sin(Q6);
  z[21] = pow(z[14],2) + pow(z[15],2);
  z[102] = L1*z[21];
  z[68] = z[20]*U5;
  z[69] = z[21]*U6;
  z[125] = (z[86]*U4+z[91]*U5+z[102]*U6)*(z[67]+z[68]+z[69]);
  z[26] = z[5]*z[10] - z[4]*z[11];
  z[101] = z[12]*z[25] - z[13]*z[26];
  z[92] = L2*z[19];
  z[93] = L2*z[20];
  z[103] = L2*z[21];
  z[126] = (z[92]*U4+z[93]*U5+z[103]*U6)*(z[67]+z[68]+z[69]);
  z[27] = z[4]*z[11] - z[5]*z[10];
  z[100] = z[12]*z[27] - z[13]*z[25];
  z[107] = (z[71]*U1+z[72]*U2)*(z[64]+z[65]);
  z[108] = (z[73]*U1+z[74]*U2)*(z[64]+z[65]);
  z[135] = -z[4]*z[7] - z[5]*z[6];
  z[134] = z[4]*z[7] + z[5]*z[6];
  z[89] = z[10]*z[13] + z[11]*z[12];
  z[118] = (z[92]*U4+z[93]*U5)*(z[67]+z[68]);
  z[117] = (z[86]*U4+z[91]*U5)*(z[67]+z[68]);
  z[170] = M3*(z[81]*z[114]+z[83]*z[112]) + 0.5*M1*z[5]*(z[70]*z[106]-z[71]*
  z[105]) + M3*(z[4]*z[76]*z[115]+z[25]*z[76]*z[125]+z[76]*z[101]*z[126]-z[5]*
  z[77]*z[115]-z[27]*z[77]*z[125]-z[77]*z[100]*z[126]) + 0.5*M2*(z[7]*z[73]*
  z[107]+2*z[5]*z[70]*z[107]-2*z[5]*z[71]*z[105]-z[7]*z[71]*z[108]-z[70]*
  z[135]*z[108]-z[73]*z[134]*z[105]) - 0.5*M2*z[70]*(z[89]*z[118]+2*z[11]*
  z[117]);
  z[194] = z[136] - z[170];
  z[2] = M2*pow(L2,2);
  z[147] = z[2]*z[17];
  z[3] = M3*pow(R,2);
  z[156] = z[3]*z[17];
  z[80] = z[7]*z[72];
  z[79] = z[6]*z[72];
  z[84] = -z[74] - z[79];
  z[133] = z[4]*z[6] - z[5]*z[7];
  z[165] = 0.08333333333333333*z[16]*z[147] + 0.4*z[16]*z[156] + M3*(z[80]*
  z[81]+z[83]*z[84]) + 0.25*M2*(z[73]*z[74]+4*z[71]*z[72]+2*z[6]*z[71]*z[74]+
  2*z[6]*z[72]*z[73]-4*z[4]*z[70]*z[72]-2*z[70]*z[74]*z[133]);
  z[146] = z[2]*z[16];
  z[155] = z[3]*z[16];
  z[171] = 0.08333333333333333*z[17]*z[146] + 0.4*z[17]*z[155] + M3*(z[80]*
  z[81]+z[83]*z[84]) + 0.25*M2*(z[73]*z[74]+4*z[71]*z[72]+2*z[6]*z[71]*z[74]+
  2*z[6]*z[72]*z[73]-4*z[4]*z[70]*z[72]-2*z[70]*z[74]*z[133]);
  z[1] = M1*pow(L1,2);
  z[142] = z[1]*z[16];
  z[164] = 0.08333333333333333*z[16]*z[142] + 0.08333333333333333*z[16]*
  z[146] + 0.4*z[16]*z[155] + M3*(pow(z[81],2)+pow(z[83],2)) + 0.25*M1*(pow(
  z[71],2)+4*pow(z[70],2)-4*z[4]*z[70]*z[71]) + 0.25*M2*(pow(z[73],2)+4*pow(
  z[70],2)+4*pow(z[71],2)+4*z[6]*z[71]*z[73]-8*z[4]*z[70]*z[71]-4*z[70]*z[73]*
  z[133]);
  z[200] = z[171]/z[164];
  TF2 = V2*U2 + C2*tanh(BETA*U2);
  z[128] = T2 - TF2;
  z[137] = z[17]*z[128];
  z[177] = M3*(z[80]*z[114]+z[84]*z[112]) + M3*z[72]*(z[5]*z[115]+z[27]*
  z[125]+z[100]*z[126]) + 0.5*M2*(z[7]*z[74]*z[107]-2*z[5]*z[72]*z[105]-z[7]*
  z[72]*z[108]-z[74]*z[134]*z[105]);
  z[195] = z[137] - z[177];
  z[206] = z[200]*z[194] - z[195];
  z[157] = z[3]*z[18];
  z[166] = 0.4*z[16]*z[157] - M3*z[82]*z[83];
  z[173] = 0.4*z[17]*z[157] - M3*z[82]*z[84];
  z[202] = z[166]*z[200] - z[173];
  z[178] = 0.4*z[18]*z[155] - M3*z[82]*z[83];
  z[207] = z[178]/z[164];
  TF3 = V3*U3 + C3*tanh(BETA*U3);
  z[129] = T3 - TF3;
  z[138] = z[18]*z[129];
  z[181] = M3*z[82]*z[112];
  z[196] = z[138] + z[181];
  z[213] = z[207]*z[194] - z[196];
  z[179] = 0.4*z[18]*z[156] - M3*z[82]*z[84];
  z[208] = z[165]*z[207] - z[179];
  z[172] = 0.08333333333333333*z[17]*z[147] + 0.4*z[17]*z[156] + M3*(pow(
  z[80],2)+pow(z[84],2)) + 0.25*M2*(pow(z[74],2)+4*pow(z[72],2)+4*z[6]*z[72]*
  z[74]);
  z[201] = z[165]*z[200] - z[172];
  z[214] = z[208]/z[201];
  z[219] = z[213] - z[214]*z[206];
  z[87] = z[11]*z[13] - z[10]*z[12];
  z[99] = z[12]*z[26] + z[13]*z[25];
  z[98] = z[12]*z[25] + z[13]*z[27];
  z[167] = 0.5*M2*z[70]*(2*z[10]*z[86]-2*z[85]-z[87]*z[92]) + M3*(z[26]*z[76]*
  z[86]+z[76]*z[92]*z[99]-z[4]*z[77]*z[85]-z[5]*z[76]*z[85]-z[25]*z[77]*z[86]-
  z[77]*z[92]*z[98]);
  z[210] = z[167]*z[207];
  z[174] = M3*z[72]*(z[4]*z[85]+z[25]*z[86]+z[92]*z[98]);
  z[203] = z[167]*z[200] - z[174];
  z[216] = z[210] - z[203]*z[214];
  TF4 = V4*U4 + C4*tanh(BETA*U4);
  z[130] = T4 - TF4;
  z[139] = z[19]*z[130];
  z[116] = z[86]*U4*z[67];
  z[88] = -z[10]*z[13] - z[11]*z[12];
  z[185] = 0.5*M1*z[11]*(z[85]*z[116]-z[86]*z[115]) - 0.5*M2*(z[13]*z[86]*
  z[118]+2*z[11]*z[86]*z[115]-4*z[11]*z[85]*z[117]-2*z[85]*z[89]*z[118]-z[13]*
  z[92]*z[117]-z[88]*z[92]*z[115]) - M3*(z[5]*z[86]*z[115]+z[11]*z[86]*z[115]+
  z[13]*z[86]*z[126]+z[27]*z[86]*z[125]+z[86]*z[100]*z[126]-2*z[11]*z[85]*
  z[125]-2*z[85]*z[89]*z[126]-z[13]*z[92]*z[125]-z[88]*z[92]*z[115]);
  z[197] = z[139] - z[185];
  z[151] = z[2]*z[20];
  z[162] = z[3]*z[20];
  z[183] = 0.08333333333333333*z[19]*z[151] + 0.4*z[19]*z[162] + M3*(z[86]*
  z[91]+z[92]*z[93]+z[12]*z[86]*z[93]+z[12]*z[91]*z[92]+2*z[85]*z[87]*z[93]-2*
  z[10]*z[85]*z[91]-z[25]*z[86]*z[91]-z[86]*z[93]*z[98]) - 0.25*M2*(8*z[10]*
  z[85]*z[91]-4*z[86]*z[91]-z[92]*z[93]-4*z[85]*z[87]*z[93]-2*z[12]*z[86]*
  z[93]-2*z[12]*z[91]*z[92]);
  z[150] = z[2]*z[19];
  z[161] = z[3]*z[19];
  z[90] = LN*z[20];
  z[186] = 0.08333333333333333*z[20]*z[150] + 0.4*z[20]*z[161] + M3*(z[86]*
  z[91]+z[92]*z[93]+2*z[85]*z[90]+z[12]*z[86]*z[93]+z[12]*z[91]*z[92]+z[85]*
  z[87]*z[93]+2*z[87]*z[90]*z[92]-2*z[10]*z[86]*z[90]-z[4]*z[85]*z[91]-z[10]*
  z[85]*z[91]-z[25]*z[86]*z[91]-z[91]*z[92]*z[98]) - 0.25*M2*(4*z[10]*z[85]*
  z[91]+8*z[10]*z[86]*z[90]-8*z[85]*z[90]-4*z[86]*z[91]-z[92]*z[93]-4*z[87]*
  z[90]*z[92]-2*z[12]*z[86]*z[93]-2*z[12]*z[91]*z[92]-2*z[85]*z[87]*z[93]);
  z[143] = z[1]*z[19];
  z[182] = 0.08333333333333333*z[19]*z[143] + 0.08333333333333333*z[19]*
  z[150] + 0.4*z[19]*z[161] + 0.25*M1*(pow(z[86],2)+4*pow(z[85],2)-4*z[10]*
  z[85]*z[86]) + M3*(pow(z[86],2)+pow(z[92],2)+2*pow(z[85],2)+2*z[12]*z[86]*
  z[92]+3*z[85]*z[87]*z[92]-3*z[10]*z[85]*z[86]-z[4]*z[85]*z[86]-z[25]*pow(
  z[86],2)-z[86]*z[92]*z[98]) - 0.25*M2*(12*z[10]*z[85]*z[86]-8*pow(z[85],2)-
  4*pow(z[86],2)-pow(z[92],2)-6*z[85]*z[87]*z[92]-4*z[12]*z[86]*z[92]);
  z[220] = z[186]/z[182];
  TF5 = V5*U5 + C5*tanh(BETA*U5);
  z[131] = T5 - TF5;
  z[140] = z[20]*z[131];
  z[189] = M3*(z[13]*z[93]*z[125]+z[88]*z[93]*z[115]+2*z[11]*z[90]*z[125]+2*
  z[89]*z[90]*z[126]-z[5]*z[91]*z[115]-z[11]*z[91]*z[115]-z[13]*z[91]*z[126]-
  z[27]*z[91]*z[125]-z[91]*z[100]*z[126]) - 0.5*M2*(z[13]*z[91]*z[118]+2*
  z[11]*z[91]*z[115]-4*z[11]*z[90]*z[117]-2*z[89]*z[90]*z[118]-z[13]*z[93]*
  z[117]-z[88]*z[93]*z[115]);
  z[198] = z[140] - z[189];
  z[223] = z[220]*z[197] - z[198];
  z[163] = z[3]*z[21];
  z[184] = 0.4*z[19]*z[163] + M3*(z[86]*z[102]+z[92]*z[103]+z[12]*z[86]*
  z[103]+z[12]*z[92]*z[102]+2*z[85]*z[87]*z[103]-2*z[10]*z[85]*z[102]-z[25]*
  z[86]*z[102]-z[86]*z[98]*z[103]);
  z[188] = 0.4*z[20]*z[163] + M3*(z[91]*z[102]+z[93]*z[103]+z[12]*z[91]*
  z[103]+z[12]*z[93]*z[102]+2*z[87]*z[90]*z[103]-2*z[10]*z[90]*z[102]-z[25]*
  z[91]*z[102]-z[91]*z[98]*z[103]);
  z[222] = z[184]*z[220] - z[188];
  z[104] = LN*z[21];
  z[190] = 0.4*z[21]*z[161] + M3*(z[86]*z[102]+z[92]*z[103]+2*z[85]*z[104]+
  z[12]*z[86]*z[103]+z[12]*z[92]*z[102]+z[85]*z[87]*z[103]+2*z[87]*z[92]*
  z[104]-2*z[10]*z[86]*z[104]-z[4]*z[85]*z[102]-z[10]*z[85]*z[102]-z[25]*
  z[86]*z[102]-z[92]*z[98]*z[102]);
  z[224] = z[190]/z[182];
  TF6 = V6*U6 + C6*tanh(BETA*U6);
  z[132] = T6 - TF6;
  z[141] = z[21]*z[132];
  z[193] = M3*(z[13]*z[103]*z[125]+z[88]*z[103]*z[115]+2*z[11]*z[104]*z[125]+
  2*z[89]*z[104]*z[126]-z[5]*z[102]*z[115]-z[11]*z[102]*z[115]-z[13]*z[102]*
  z[126]-z[27]*z[102]*z[125]-z[100]*z[102]*z[126]);
  z[199] = z[141] - z[193];
  z[227] = z[224]*z[197] - z[199];
  z[191] = 0.4*z[21]*z[162] + M3*(z[91]*z[102]+z[93]*z[103]+z[12]*z[91]*
  z[103]+z[12]*z[93]*z[102]+2*z[87]*z[93]*z[104]-2*z[10]*z[91]*z[104]-z[25]*
  z[91]*z[102]-z[93]*z[98]*z[102]);
  z[225] = z[183]*z[224] - z[191];
  z[187] = 0.08333333333333333*z[20]*z[151] + 0.4*z[20]*z[162] + M3*(pow(
  z[91],2)+pow(z[93],2)+2*z[12]*z[91]*z[93]+2*z[87]*z[90]*z[93]-2*z[10]*z[90]*
  z[91]-z[25]*pow(z[91],2)-z[91]*z[93]*z[98]) - 0.25*M2*(8*z[10]*z[90]*z[91]-
  4*pow(z[91],2)-pow(z[93],2)-4*z[12]*z[91]*z[93]-4*z[87]*z[90]*z[93]);
  z[221] = z[183]*z[220] - z[187];
  z[228] = z[225]/z[221];
  z[230] = z[227] - z[228]*z[223];
  z[192] = 0.4*z[21]*z[163] + M3*(pow(z[102],2)+pow(z[103],2)+2*z[12]*z[102]*
  z[103]+2*z[87]*z[103]*z[104]-2*z[10]*z[102]*z[104]-z[25]*pow(z[102],2)-
  z[98]*z[102]*z[103]);
  z[226] = z[184]*z[224] - z[192];
  z[229] = z[226] - z[222]*z[228];
  z[231] = z[230]/z[229];
  z[232] = (z[223]-z[222]*z[231])/z[221];
  z[233] = (z[197]-z[183]*z[232]-z[184]*z[231])/z[182];
  z[168] = 0.5*M2*z[70]*(2*z[10]*z[91]-z[87]*z[93]) + M3*(z[26]*z[76]*z[91]+
  z[76]*z[93]*z[99]-z[25]*z[77]*z[91]-z[77]*z[93]*z[98]);
  z[211] = z[168]*z[207];
  z[175] = M3*z[72]*(z[25]*z[91]+z[93]*z[98]);
  z[204] = z[168]*z[200] - z[175];
  z[217] = z[211] - z[204]*z[214];
  z[169] = M3*(z[26]*z[76]*z[102]+z[76]*z[99]*z[103]-z[25]*z[77]*z[102]-z[77]*
  z[98]*z[103]);
  z[212] = z[169]*z[207];
  z[176] = M3*z[72]*(z[25]*z[102]+z[98]*z[103]);
  z[205] = z[169]*z[200] - z[176];
  z[218] = z[212] - z[205]*z[214];
  z[180] = 0.4*z[18]*z[157] + M3*pow(z[82],2);
  z[209] = z[166]*z[207] - z[180];
  z[215] = z[209] - z[202]*z[214];
  z[234] = (z[219]-z[216]*z[233]-z[217]*z[232]-z[218]*z[231])/z[215];
  z[235] = (z[206]-z[202]*z[234]-z[203]*z[233]-z[204]*z[232]-z[205]*z[231])/
  z[201];
  z[236] = (z[194]-z[165]*z[235]-z[166]*z[234]-z[167]*z[233]-z[168]*z[232]-
  z[169]*z[231])/z[164];
  U1p = z[236];
  U2p = z[235];
  U3p = z[234];
  U4p = z[233];
  U5p = z[232];
  U6p = z[231];

  PX[0] = 0;
  PX[1] = -L1*z[5];
  PX[2] = L2*z[135] - L1*z[5];
  PX[3] = 0;
  PX[4] = L1*z[11];
  PX[5] = L1*z[11] + L2*z[89];
  PY[0] = -LN;
  PY[1] = L1*z[4] - LN;
  PY[2] = L1*z[4] + L2*z[133] - LN;
  PY[3] = LN;
  PY[4] = LN - L1*z[10];
  PY[5] = LN + L2*z[87] - L1*z[10];
}

